<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Napkin Producer Amplifier — Script Breakdown</title>
<style>
/* ── Reset & Base ─────────────────────────────────────── */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#ffffff;--bg2:#f5f6f8;--bg3:#ebedf0;
  --text:#1a1a2e;--text2:#555;--text3:#888;
  --accent:#e63946;--accent2:#d62839;
  --blue:#2563eb;--blue2:#1d4ed8;
  --green:#16a34a;--green2:#15803d;
  --border:#ddd;--border2:#ccc;
  --shadow:0 2px 12px rgba(0,0,0,0.08);
  --r1:#5a9e6f;--r2:#8fb065;--r3:#c9a84c;--r4:#cf7a3a;--r5:#c4463a;
  --radius:10px;
  --chat-w:380px;
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:var(--bg2);color:var(--text);line-height:1.5}
a{color:var(--blue);text-decoration:none}

/* ── Top Bar ──────────────────────────────────────────── */
.topbar{background:#fff;border-bottom:1px solid var(--border);
  padding:12px 24px;display:flex;align-items:center;gap:16px;
  position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
.topbar h1{font-size:18px;font-weight:700;color:var(--text)}
.topbar h1 span{color:var(--accent);font-weight:800}
.topbar .subtitle{font-size:12px;color:var(--text3);margin-left:-8px}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:12px}

/* Budget Button */
.budget-btn{background:var(--accent);color:#fff;border:none;padding:8px 18px;
  border-radius:20px;font-weight:600;font-size:13px;cursor:pointer;
  display:flex;align-items:center;gap:6px;transition:all .2s;
  box-shadow:0 2px 8px rgba(230,57,70,0.3)}
.budget-btn:hover{background:var(--accent2);transform:translateY(-1px)}
.budget-btn .live-dot{width:8px;height:8px;border-radius:50%;
  background:#fff;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Chat Toggle */
.chat-toggle-btn{background:var(--blue);color:#fff;border:none;padding:8px 18px;
  border-radius:20px;font-weight:600;font-size:13px;cursor:pointer;
  display:flex;align-items:center;gap:6px;transition:all .2s;
  box-shadow:0 2px 8px rgba(37,99,235,0.3)}
.chat-toggle-btn:hover{background:var(--blue2);transform:translateY(-1px)}

/* ── Hero Upload Section ─────────────────────────────── */
.hero{background:#fff;border-radius:var(--radius);
  margin:24px auto;max-width:800px;padding:48px 40px;text-align:center;
  box-shadow:var(--shadow);border:2px dashed var(--border2);
  transition:border-color .3s,background .3s}
.hero.drag-over{border-color:var(--accent);background:#fef2f2}
.hero.has-results{padding:20px 24px;border:1px solid var(--border)}
.hero h2{font-size:28px;font-weight:700;margin-bottom:8px}
.hero h2 span{color:var(--accent)}
.hero p{color:var(--text2);font-size:15px;margin-bottom:24px}
.hero .formats{color:var(--text3);font-size:12px;margin-top:12px}

.upload-btn{background:var(--accent);color:#fff;border:none;
  padding:14px 36px;border-radius:8px;font-size:16px;font-weight:700;
  cursor:pointer;transition:all .2s;box-shadow:0 4px 16px rgba(230,57,70,0.25)}
.upload-btn:hover{background:var(--accent2);transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(230,57,70,0.35)}

.upload-status{margin-top:16px;font-size:14px;color:var(--text2)}
.upload-status.error{color:var(--r5)}
.upload-status.success{color:var(--green)}

/* Loading spinner */
.spinner{display:inline-block;width:20px;height:20px;
  border:3px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .8s linear infinite;margin-right:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── Project Summary Bar ─────────────────────────────── */
.summary-bar{background:#fff;border-radius:var(--radius);
  margin:0 auto 20px;max-width:1200px;padding:16px 24px;
  box-shadow:var(--shadow);display:flex;flex-wrap:wrap;gap:24px;align-items:center}
.summary-bar .stat{text-align:center}
.summary-bar .stat .num{font-size:24px;font-weight:700;color:var(--accent)}
.summary-bar .stat .label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.summary-bar .title-display{font-size:18px;font-weight:700;flex:1}

/* ── Filters ─────────────────────────────────────────── */
.filters{background:#fff;border-radius:var(--radius);
  margin:0 auto 20px;max-width:1200px;padding:14px 20px;
  box-shadow:var(--shadow);display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.filter-label{font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;margin-right:4px}
.filter-chip{padding:5px 12px;border-radius:16px;font-size:12px;
  border:1px solid var(--border);background:var(--bg);cursor:pointer;
  transition:all .2s;color:var(--text2)}
.filter-chip:hover{border-color:var(--accent);color:var(--accent)}
.filter-chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* ── Scene Cards ─────────────────────────────────────── */
.scenes-container{max-width:1200px;margin:0 auto;padding:0 16px 100px}
.scene-card{background:#fff;border-radius:var(--radius);margin-bottom:14px;
  box-shadow:var(--shadow);overflow:hidden;border-left:4px solid var(--border)}
.scene-card[data-risk="1"]{border-left-color:var(--r1)}
.scene-card[data-risk="2"]{border-left-color:var(--r2)}
.scene-card[data-risk="3"]{border-left-color:var(--r3)}
.scene-card[data-risk="4"]{border-left-color:var(--r4)}
.scene-card[data-risk="5"]{border-left-color:var(--r5)}

.scene-header{padding:14px 20px;cursor:pointer;display:flex;align-items:center;
  gap:12px;transition:background .2s}
.scene-header:hover{background:var(--bg2)}
.scene-num{font-weight:700;font-size:14px;color:var(--accent);min-width:36px}
.scene-slug{font-weight:600;font-size:14px;flex:1}
.scene-ie{font-size:11px;padding:2px 8px;border-radius:4px;font-weight:600}
.scene-ie.INT{background:#e0e7ff;color:#3730a3}
.scene-ie.EXT{background:#dcfce7;color:#166534}
.scene-dn{font-size:11px;padding:2px 8px;border-radius:4px;font-weight:600;
  background:var(--bg3);color:var(--text2)}
.scene-vfx-count{font-size:11px;padding:2px 10px;border-radius:10px;
  background:#fef2f2;color:var(--accent);font-weight:600}
.scene-risk{width:28px;height:28px;border-radius:50%;display:flex;
  align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.risk-1{background:var(--r1)}.risk-2{background:var(--r2)}.risk-3{background:var(--r3)}
.risk-4{background:var(--r4)}.risk-5{background:var(--r5)}
.scene-chevron{font-size:18px;color:var(--text3);transition:transform .2s}
.scene-card.open .scene-chevron{transform:rotate(90deg)}

.scene-body{display:none;padding:0 20px 16px;border-top:1px solid var(--bg3)}
.scene-card.open .scene-body{display:block}

.scene-meta{display:flex;flex-wrap:wrap;gap:16px;margin:12px 0;font-size:13px;color:var(--text2)}
.scene-meta strong{color:var(--text)}

.vfx-tags{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0}
.vfx-tag{font-size:11px;padding:3px 10px;border-radius:12px;font-weight:500}
.vfx-tag.sev-1{background:#f0fdf4;color:#166534;border:1px solid #bbf7d0}
.vfx-tag.sev-2{background:#fefce8;color:#854d0e;border:1px solid #fef08a}
.vfx-tag.sev-3{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
.vfx-tag.sev-4{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
.vfx-tag.sev-5{background:#fef2f2;color:#7f1d1d;border:1px solid #fca5a5}

.scene-characters{margin:8px 0;display:flex;flex-wrap:wrap;gap:6px}
.char-chip{font-size:11px;padding:3px 10px;border-radius:12px;
  background:var(--bg2);color:var(--text2);border:1px solid var(--border)}

.scene-context{font-size:13px;color:var(--text2);margin:8px 0;
  padding:10px;background:var(--bg2);border-radius:6px;line-height:1.6}

/* ── AI Chat Panel ───────────────────────────────────── */
.chat-panel{position:fixed;right:0;top:0;bottom:0;width:var(--chat-w);
  background:#fff;box-shadow:-4px 0 24px rgba(0,0,0,0.1);
  z-index:200;display:flex;flex-direction:column;
  transform:translateX(100%);transition:transform .3s ease}
.chat-panel.open{transform:translateX(0)}

.chat-header{padding:16px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;background:var(--blue);color:#fff}
.chat-header h3{font-size:15px;font-weight:600;flex:1}
.chat-close{background:none;border:none;color:#fff;font-size:20px;
  cursor:pointer;opacity:.8;transition:opacity .2s}
.chat-close:hover{opacity:1}

.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;
  flex-direction:column;gap:12px}
.chat-msg{max-width:85%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5}
.chat-msg.assistant{background:var(--bg2);align-self:flex-start;
  border-bottom-left-radius:4px}
.chat-msg.user{background:var(--blue);color:#fff;align-self:flex-end;
  border-bottom-right-radius:4px}
.chat-msg .model-badge{font-size:10px;color:var(--text3);margin-bottom:4px;
  text-transform:uppercase;letter-spacing:.5px}

.chat-input-row{padding:12px 16px;border-top:1px solid var(--border);
  display:flex;gap:8px}
.chat-input-row input{flex:1;padding:10px 14px;border:1px solid var(--border);
  border-radius:8px;font-size:13px;outline:none;transition:border-color .2s}
.chat-input-row input:focus{border-color:var(--blue)}
.chat-send{background:var(--blue);color:#fff;border:none;padding:10px 16px;
  border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;transition:all .2s}
.chat-send:hover{background:var(--blue2)}

/* ── Budget Panel ────────────────────────────────────── */
.budget-panel{position:fixed;left:0;top:0;bottom:0;width:360px;
  background:#fff;box-shadow:4px 0 24px rgba(0,0,0,0.1);
  z-index:200;transform:translateX(-100%);transition:transform .3s ease;
  display:flex;flex-direction:column}
.budget-panel.open{transform:translateX(0)}
.budget-header{padding:16px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;background:var(--accent);color:#fff}
.budget-header h3{font-size:15px;font-weight:600;flex:1}
.budget-close{background:none;border:none;color:#fff;font-size:20px;
  cursor:pointer;opacity:.8}
.budget-body{flex:1;overflow-y:auto;padding:20px}
.budget-stat{margin-bottom:20px}
.budget-stat .blabel{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.budget-stat .bval{font-size:28px;font-weight:700;color:var(--text)}
.budget-stat .bval.over{color:var(--r5)}
.budget-stat .bval.under{color:var(--green)}

/* ── Hidden ──────────────────────────────────────────── */
.hidden{display:none!important}

/* ── Responsive ──────────────────────────────────────── */
@media(max-width:768px){
  .hero{margin:12px;padding:32px 20px}
  .hero h2{font-size:22px}
  .chat-panel{width:100%}
  .budget-panel{width:100%}
  .scenes-container{padding:0 8px 100px}
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <h1><span>NPA</span> Napkin Producer Amplifier</h1>
  <span class="subtitle">v0.4 — Production Intelligence</span>
  <div class="topbar-right">
    <button class="budget-btn" id="budgetToggle" onclick="toggleBudget()">
      <span class="live-dot"></span> LIVE BUDGET
    </button>
    <button class="chat-toggle-btn" id="chatToggle" onclick="toggleChat()">
      AI Assistant
    </button>
  </div>
</div>

<!-- HERO UPLOAD -->
<div class="hero" id="heroUpload">
  <h2>Upload Your <span>Script</span></h2>
  <p>Drop any screenplay format and the AI will break it down into scenes, characters, VFX triggers, and risk scores.</p>
  <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
    Upload Script
  </button>
  <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt,.fdx,.fountain,.rtf,.json,.csv" style="display:none">
  <div class="formats">Supports: PDF, Word (.docx), Final Draft (.fdx), Fountain, TXT, RTF, JSON, CSV</div>
  <div class="upload-status" id="uploadStatus"></div>
</div>

<!-- SUMMARY BAR (hidden until results) -->
<div class="summary-bar hidden" id="summaryBar">
  <div class="title-display" id="projectTitle">Untitled</div>
  <div class="stat"><div class="num" id="statScenes">0</div><div class="label">Scenes</div></div>
  <div class="stat"><div class="num" id="statChars">0</div><div class="label">Characters</div></div>
  <div class="stat"><div class="num" id="statPages">0</div><div class="label">Est. Pages</div></div>
  <div class="stat"><div class="num" id="statVfx">0</div><div class="label">VFX Triggers</div></div>
  <button class="upload-btn" style="padding:8px 20px;font-size:13px" onclick="document.getElementById('fileInput').click()">
    Upload New Script
  </button>
</div>

<!-- FILTERS (hidden until results) -->
<div class="filters hidden" id="filtersBar">
  <span class="filter-label">Filter:</span>
  <span class="filter-chip active" data-filter="all" onclick="filterScenes('all',this)">All Scenes</span>
  <span class="filter-chip" data-filter="vfx" onclick="filterScenes('vfx',this)">Has VFX</span>
  <span class="filter-chip" data-filter="high" onclick="filterScenes('high',this)">High Risk</span>
  <span class="filter-chip" data-filter="INT" onclick="filterScenes('INT',this)">INT</span>
  <span class="filter-chip" data-filter="EXT" onclick="filterScenes('EXT',this)">EXT</span>
</div>

<!-- SCENE CARDS -->
<div class="scenes-container" id="scenesContainer"></div>

<!-- AI CHAT PANEL -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <h3>AI Production Assistant</h3>
    <button class="chat-close" onclick="toggleChat()">&#x2715;</button>
  </div>
  <div class="chat-messages" id="chatMessages">
    <div class="chat-msg assistant">
      <div class="model-badge">NPA Assistant</div>
      Hi! I'm your production AI. Upload a script and ask me anything about scenes, VFX complexity, budget implications, or scheduling.
    </div>
  </div>
  <div class="chat-input-row">
    <input type="text" id="chatInput" placeholder="Ask about your script..." onkeydown="if(event.key==='Enter')sendChat()">
    <button class="chat-send" onclick="sendChat()">Send</button>
  </div>
</div>

<!-- BUDGET PANEL -->
<div class="budget-panel" id="budgetPanel">
  <div class="budget-header">
    <h3>Live Budget</h3>
    <button class="budget-close" onclick="toggleBudget()">&#x2715;</button>
  </div>
  <div class="budget-body" id="budgetBody">
    <div class="budget-stat">
      <div class="blabel">Total Budget</div>
      <div class="bval" id="budgetTotal">&mdash;</div>
    </div>
    <div class="budget-stat">
      <div class="blabel">Actual Spend</div>
      <div class="bval" id="budgetActual">&mdash;</div>
    </div>
    <div class="budget-stat">
      <div class="blabel">Variance</div>
      <div class="bval" id="budgetVariance">&mdash;</div>
    </div>
    <p style="font-size:13px;color:var(--text3);margin-top:24px">
      Connect your master budget Excel to see live figures.
    </p>
  </div>
</div>

<!-- JAVASCRIPT -->
<script>
/* ── Configuration ─────────────────────────────────── */
var API_BASE = window.location.origin;
var currentScenes = [];
var currentData = null;

/* ── VFX Category Map ──────────────────────────────── */
var VFX_CATS = {
  digital_augmentation:"Digital", vehicles_mech:"Vehicles", weapons_combat:"Weapons",
  destruction_damage:"Destruction", weather_atmosphere:"Weather", creatures_animals:"Creatures",
  supernatural_magic:"Supernatural", water_work:"Water", aerial_height:"Aerial",
  crowd_extras:"Crowds", fire_pyro:"Fire / Pyro", set_extension:"Set Extension", stunts:"Stunts"
};

/* ── Upload Handler ──────────────────────────────── */
var fileInput = document.getElementById('fileInput');
var heroEl = document.getElementById('heroUpload');
var statusEl = document.getElementById('uploadStatus');

fileInput.addEventListener('change', function(e){
  if(e.target.files.length) handleUpload(e.target.files[0]);
});

// Drag and drop
heroEl.addEventListener('dragover', function(e){e.preventDefault();heroEl.classList.add('drag-over')});
heroEl.addEventListener('dragleave', function(){heroEl.classList.remove('drag-over')});
heroEl.addEventListener('drop', function(e){
  e.preventDefault();heroEl.classList.remove('drag-over');
  if(e.dataTransfer.files.length) handleUpload(e.dataTransfer.files[0]);
});

async function handleUpload(file){
  statusEl.className = 'upload-status';
  statusEl.innerHTML = '<span class="spinner"></span> Uploading and analyzing <strong>' + file.name + '</strong> ...';

  // Check if it is a JSON file (pre-built breakdown)
  var ext = file.name.split('.').pop().toLowerCase();
  if(ext === 'json'){
    try{
      var text = await file.text();
      var data = JSON.parse(text);
      if(data.scenes){
        displayJsonBreakdown(data);
        statusEl.innerHTML = '';
        return;
      }
    }catch(err){
      statusEl.className = 'upload-status error';
      statusEl.textContent = 'Invalid JSON file: ' + err.message;
      return;
    }
  }

  // POST to backend for real parsing
  var formData = new FormData();
  formData.append('file', file);
  formData.append('title', file.name.replace(/\.[^/.]+$/,''));

  try{
    var resp = await fetch(API_BASE + '/api/script/upload', {
      method:'POST', body: formData
    });

    if(!resp.ok){
      var errData = await resp.json().catch(function(){return {detail:'Server error'}});
      throw new Error(errData.detail || errData.error || 'Upload failed (HTTP ' + resp.status + ')');
    }

    var data = await resp.json();
    currentData = data;
    displayBackendResults(data);
    statusEl.className = 'upload-status success';
    statusEl.innerHTML = 'Parsed <strong>' + data.scene_count + ' scenes</strong>, <strong>' + data.character_count + ' characters</strong>';

    // Notify chat
    addChatMessage('assistant', 'Script loaded: "' + data.title + '" with ' + data.scene_count + ' scenes, ' +
      data.character_count + ' characters, approx ' + data.total_pages_estimate + ' pages. Ask me anything about it!');

  }catch(err){
    console.error('Upload failed:', err);
    statusEl.className = 'upload-status error';
    statusEl.textContent = 'Error: ' + err.message;

    // Fallback: try client-side parsing for plain text files
    if(ext === 'txt' || ext === 'fountain' || ext === 'rtf'){
      statusEl.textContent += ' Trying local parsing...';
      try{
        var textContent = await file.text();
        var scenes = parseTextLocally(textContent);
        displayLocalScenes(scenes, file.name);
        statusEl.className = 'upload-status success';
        statusEl.textContent = 'Parsed locally (' + scenes.length + ' scenes). For full VFX analysis, start the backend server.';
      }catch(e2){
        statusEl.className = 'upload-status error';
        statusEl.textContent = 'Could not parse file. Make sure the backend server is running (uvicorn sba.app:app --reload)';
      }
    } else {
      statusEl.textContent += ' Make sure the backend server is running: cd src && uvicorn sba.app:app --reload';
    }
  }
}

/* ── Map Backend Response to UI ────────────────────── */
function displayBackendResults(data){
  document.getElementById('summaryBar').classList.remove('hidden');
  document.getElementById('filtersBar').classList.remove('hidden');
  heroEl.classList.add('has-results');

  document.getElementById('projectTitle').textContent = data.title || 'Untitled Script';
  document.getElementById('statScenes').textContent = data.scene_count;
  document.getElementById('statChars').textContent = data.character_count;
  document.getElementById('statPages').textContent = data.total_pages_estimate;

  var totalVfx = 0;
  var scenes = data.scenes.map(function(s, i){
    var vfxCats = {};
    var maxSeverity = 0;
    (s.vfx_triggers || []).forEach(function(t){
      totalVfx++;
      vfxCats[t.category] = (vfxCats[t.category]||0) + 1;
      if(t.severity > maxSeverity) maxSeverity = t.severity;
    });

    var risk = maxSeverity >= 4 ? 5 : maxSeverity >= 3 ? 4 : maxSeverity >= 2 ? 3 : maxSeverity >= 1 ? 2 : 1;

    return {
      id: s.scene_number || (i+1),
      slug: s.slugline || ('SCENE ' + (i+1)),
      ie: s.int_ext || '',
      dn: s.day_night || '',
      location: s.location || '',
      characters: s.characters || [],
      wordCount: s.word_count || 0,
      vfxTriggers: s.vfx_triggers || [],
      vfxCats: Object.keys(vfxCats),
      risk: risk,
      maxSeverity: maxSeverity
    };
  });

  document.getElementById('statVfx').textContent = totalVfx;
  currentScenes = scenes;
  renderScenes(scenes);
}

/* ── Display JSON Breakdown (pre-built) ───────────── */
function displayJsonBreakdown(data){
  document.getElementById('summaryBar').classList.remove('hidden');
  document.getElementById('filtersBar').classList.remove('hidden');
  heroEl.classList.add('has-results');

  var scenes = (data.scenes || []).map(function(s, i){
    return {
      id: s.id || s.scene_number || (i+1),
      slug: s.slug || s.slugline || ('SCENE '+(i+1)),
      ie: s.ie || s.int_ext || '',
      dn: s.dn || s.day_night || '',
      location: s.location || '',
      characters: s.ch || s.characters || [],
      wordCount: s.word_count || 0,
      vfxTriggers: (s.vfx_triggers || []),
      vfxCats: s.cats || [],
      risk: s.cr || 1,
      sum: s.sum || ''
    };
  });

  document.getElementById('projectTitle').textContent = data.title || data.project_summary?.title || 'Script';
  document.getElementById('statScenes').textContent = scenes.length;
  document.getElementById('statPages').textContent = data.total_pages_estimate || '-';
  document.getElementById('statChars').textContent = data.character_count || (data.characters||[]).length || '-';
  document.getElementById('statVfx').textContent = scenes.reduce(function(n,s){return n+(s.vfxTriggers||[]).length},0);
  currentScenes = scenes;
  renderScenes(scenes);
}

/* ── Local Text Parsing (fallback when no backend) ── */
function parseTextLocally(text){
  var sceneRe = /^(INT\.|EXT\.|INT\/EXT\.|I\/E\.)\s*(.+)/gim;
  var scenes = [];
  var match;
  var positions = [];
  while((match = sceneRe.exec(text)) !== null){
    positions.push({index:match.index, heading:match[0], ie:match[1].replace(/[.\/ ]/g,''), rest:match[2]});
  }
  for(var i=0;i<positions.length;i++){
    var start = positions[i].index;
    var end = i+1<positions.length ? positions[i+1].index : text.length;
    var body = text.substring(start, end);
    var dn = /\bNIGHT\b/i.test(positions[i].rest) ? 'NIGHT' : 'DAY';
    scenes.push({
      id:i+1, slug:positions[i].heading.trim(), ie:positions[i].ie.replace('IE','INT/EXT'),
      dn:dn, characters:[], vfxTriggers:[], vfxCats:[], risk:1, wordCount:body.split(/\s+/).length
    });
  }
  return scenes;
}

function displayLocalScenes(scenes, filename){
  document.getElementById('summaryBar').classList.remove('hidden');
  document.getElementById('filtersBar').classList.remove('hidden');
  heroEl.classList.add('has-results');
  document.getElementById('projectTitle').textContent = filename.replace(/\.[^/.]+$/,'');
  document.getElementById('statScenes').textContent = scenes.length;
  document.getElementById('statChars').textContent = '-';
  document.getElementById('statPages').textContent = Math.round(scenes.reduce(function(n,s){return n+s.wordCount},0)/250);
  document.getElementById('statVfx').textContent = '0';
  currentScenes = scenes;
  renderScenes(scenes);
}

/* ── Render Scene Cards ──────────────────────────────── */
function renderScenes(scenes){
  var container = document.getElementById('scenesContainer');
  container.innerHTML = '';

  scenes.forEach(function(s){
    var card = document.createElement('div');
    card.className = 'scene-card';
    card.dataset.risk = s.risk;
    card.dataset.ie = s.ie;
    card.dataset.hasVfx = (s.vfxTriggers && s.vfxTriggers.length > 0) ? 'true' : 'false';

    // Header
    var header = document.createElement('div');
    header.className = 'scene-header';
    header.onclick = function(){card.classList.toggle('open')};

    var headerHTML = '<span class="scene-num">#' + s.id + '</span>';
    headerHTML += '<span class="scene-slug">' + escHtml(s.slug) + '</span>';
    if(s.ie) headerHTML += '<span class="scene-ie ' + s.ie + '">' + s.ie + '</span>';
    if(s.dn) headerHTML += '<span class="scene-dn">' + s.dn + '</span>';
    if(s.vfxTriggers && s.vfxTriggers.length > 0){
      headerHTML += '<span class="scene-vfx-count">' + s.vfxTriggers.length + ' VFX</span>';
    }
    headerHTML += '<span class="scene-risk risk-' + s.risk + '">' + s.risk + '</span>';
    headerHTML += '<span class="scene-chevron">&#x203A;</span>';
    header.innerHTML = headerHTML;
    card.appendChild(header);

    // Body
    var body = document.createElement('div');
    body.className = 'scene-body';

    var bodyHTML = '<div class="scene-meta">';
    if(s.wordCount) bodyHTML += '<span><strong>Words:</strong> ' + s.wordCount + '</span>';
    if(s.location) bodyHTML += '<span><strong>Location:</strong> ' + escHtml(s.location) + '</span>';
    bodyHTML += '<span><strong>Risk Level:</strong> ' + ['','Minimal','Mild','Moderate','High','Critical'][s.risk] + '</span>';
    bodyHTML += '</div>';

    // Characters
    if(s.characters && s.characters.length){
      bodyHTML += '<div style="margin:8px 0"><strong style="font-size:12px;color:var(--text3)">CHARACTERS</strong></div>';
      bodyHTML += '<div class="scene-characters">';
      s.characters.forEach(function(c){
        bodyHTML += '<span class="char-chip">' + escHtml(c) + '</span>';
      });
      bodyHTML += '</div>';
    }

    // VFX Triggers
    if(s.vfxTriggers && s.vfxTriggers.length){
      bodyHTML += '<div style="margin:12px 0 6px"><strong style="font-size:12px;color:var(--text3)">VFX TRIGGERS</strong></div>';
      bodyHTML += '<div class="vfx-tags">';
      s.vfxTriggers.forEach(function(t){
        var sev = t.severity || 1;
        var catLabel = VFX_CATS[t.category] || t.category;
        bodyHTML += '<span class="vfx-tag sev-' + Math.min(sev,5) + '">' + escHtml(catLabel) + ': ' + escHtml(t.keyword || t.matched_keyword || '') + '</span>';
      });
      bodyHTML += '</div>';

      // Show contexts
      s.vfxTriggers.forEach(function(t){
        if(t.context){
          bodyHTML += '<div class="scene-context"><strong>' + escHtml(VFX_CATS[t.category]||t.category) + ':</strong> "' + escHtml(t.context) + '"</div>';
        }
      });
    }

    // Summary
    if(s.sum){
      bodyHTML += '<div class="scene-context"><strong>Summary:</strong> ' + escHtml(s.sum) + '</div>';
    }

    body.innerHTML = bodyHTML;
    card.appendChild(body);
    container.appendChild(card);
  });
}

function escHtml(str){
  if(!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ── Filters ─────────────────────────────────────────── */
function filterScenes(type, chip){
  document.querySelectorAll('.filter-chip').forEach(function(c){c.classList.remove('active')});
  if(chip) chip.classList.add('active');

  var filtered = currentScenes;
  if(type === 'vfx') filtered = currentScenes.filter(function(s){return s.vfxTriggers && s.vfxTriggers.length > 0});
  else if(type === 'high') filtered = currentScenes.filter(function(s){return s.risk >= 4});
  else if(type === 'INT') filtered = currentScenes.filter(function(s){return s.ie === 'INT'});
  else if(type === 'EXT') filtered = currentScenes.filter(function(s){return s.ie === 'EXT'});

  renderScenes(filtered);
}

/* ── Chat ────────────────────────────────────────────── */
function toggleChat(){
  document.getElementById('chatPanel').classList.toggle('open');
}
function toggleBudget(){
  document.getElementById('budgetPanel').classList.toggle('open');
}

function addChatMessage(role, text){
  var div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  div.textContent = text;
  document.getElementById('chatMessages').appendChild(div);
  document.getElementById('chatMessages').scrollTop = 999999;
}

async function sendChat(){
  var input = document.getElementById('chatInput');
  var msg = input.value.trim();
  if(!msg) return;
  input.value = '';
  addChatMessage('user', msg);

  try{
    var resp = await fetch(API_BASE + '/api/chat/message', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({message: msg, context: currentData ? {
        title: currentData.title,
        scene_count: currentData.scene_count,
        character_count: currentData.character_count
      } : null})
    });
    if(!resp.ok) throw new Error('Chat failed');
    var data = await resp.json();
    var reply = data.response || data.message || data.reply || JSON.stringify(data);
    addChatMessage('assistant', reply);
  }catch(err){
    addChatMessage('assistant', 'Could not connect to the AI backend. Make sure the server is running.');
  }
}

/* ── Budget ──────────────────────────────────────────── */
async function loadBudget(){
  try{
    var resp = await fetch(API_BASE + '/api/budget/summary');
    if(!resp.ok) return;
    var data = await resp.json();
    if(data.total) document.getElementById('budgetTotal').textContent = '$' + Number(data.total).toLocaleString();
    if(data.actual) document.getElementById('budgetActual').textContent = '$' + Number(data.actual).toLocaleString();
    if(data.variance != null){
      var vEl = document.getElementById('budgetVariance');
      var v = Number(data.variance);
      vEl.textContent = (v >= 0 ? '+' : '') + '$' + v.toLocaleString();
      vEl.className = 'bval ' + (v < 0 ? 'over' : 'under');
    }
  }catch(e){}
}

/* ── Health Check on Load ────────────────────────────── */
window.addEventListener('DOMContentLoaded', function(){
  fetch(API_BASE + '/api/health').then(function(r){
    if(r.ok) console.log('NPA backend connected');
  }).catch(function(){
    console.warn('NPA backend not available. Client-side only mode.');
  });
  loadBudget();

  // Open chat by default so it is prominent
  setTimeout(function(){ document.getElementById('chatPanel').classList.add('open'); }, 500);
});
</script>

<!-- NPA Integration Layer -->
<script src="npa-integration.js"></script>
</body>
</html>
